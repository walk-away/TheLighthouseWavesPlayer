<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:TheLighthouseWavesPlayerVideoApp.ViewModels"
             x:DataType="vm:VideoPlayerViewModel"
             x:Class="TheLighthouseWavesPlayerVideoApp.Views.VideoPlayerPage"
             Title="{Binding Title}"
             Shell.NavBarIsVisible="True">

    <VisualStateManager.VisualStateGroups>
        <!-- Existing visual states -->
    </VisualStateManager.VisualStateGroups>

    <Grid RowDefinitions="Auto, *, Auto">

        <Label Grid.Row="0"
               x:Name="TitleLabel"
               Text="{Binding Title}"
               FontSize="Large"
               HorizontalOptions="Center"
               Margin="10" />

        <Grid Grid.Row="1">
            <!-- Media Element -->
            <toolkit:MediaElement Grid.Row="1"
                              x:Name="mediaElement"
                              Source="{Binding VideoSource}"
                              ShouldAutoPlay="False"
                              ShouldShowPlaybackControls="True"
                              Aspect="AspectFit"
                              StateChanged="MediaElement_StateChanged"
                              MediaOpened="MediaElement_MediaOpened"
                              MediaEnded="MediaElement_MediaEnded"
                              PositionChanged="MediaElement_PositionChanged"
                              Volume="1" />

            <!-- Subtitle overlay -->
            <Border IsVisible="{Binding HasSubtitles}"
                   HorizontalOptions="Center"
                   VerticalOptions="End"
                   Margin="0,0,0,20"
                   StrokeShape="RoundRectangle 10"
                   BackgroundColor="#80000000"
                   Padding="10,5"
                   MaximumWidthRequest="600">
                <Label Text="{Binding CurrentSubtitleText}" 
                       TextColor="White" 
                       FontSize="18"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center" />
            </Border>
            
            <!-- Video Info Overlay -->
            <Border IsVisible="{Binding IsVideoInfoVisible}"
                    StrokeShape="RoundRectangle 10"
                    Padding="15"
                    HorizontalOptions="End"
                    VerticalOptions="Start"
                    Margin="10"
                    BackgroundColor="{AppThemeBinding Light={StaticResource OverlayBackgroundLight}, Dark={StaticResource OverlayBackgroundDark}}"
                    StrokeThickness="0">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Video Information" Style="{StaticResource OverlayHeaderLabelStyle}"/>
                    
                    <BoxView HeightRequest="1"
                             Opacity="0.5"
                             Margin="0,2,0,5"
                             BackgroundColor="{AppThemeBinding Light={StaticResource OverlayTextLight}, Dark={StaticResource OverlayTextDark}}"/>

                    <Label Text="{Binding VideoInfo.FileName}" Style="{StaticResource OverlayLabelStyle}"/>
                    <Label Text="{Binding VideoInfo.FormattedFileSize}" Style="{StaticResource OverlayLabelStyle}"/>
                    <Label Text="{Binding VideoInfo.Resolution}" Style="{StaticResource OverlayLabelStyle}"/>
                    <Label Text="{Binding VideoInfo.Duration, StringFormat='Duration: {0:hh\\:mm\\:ss}'}" Style="{StaticResource OverlayLabelStyle}"/>
                    <Label Text="{Binding VideoInfo.LastModified, StringFormat='Modified: {0:d}'}" Style="{StaticResource OverlayLabelStyle}"/>
                </VerticalStackLayout>
            </Border>
            
            <!-- Loading overlay -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                             IsVisible="{Binding IsBusy}"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"/>
        </Grid>

        <Grid Grid.Row="2"
              x:Name="BottomControlsGrid"
              ColumnDefinitions="*, Auto, Auto, Auto, Auto"
              Margin="10"
              Padding="10,0"
              VerticalOptions="Center">

            <Slider Grid.Column="0"
                    x:Name="VolumeSlider"
                    Minimum="0"
                    Maximum="1"
                    Value="{Binding Source={x:Reference mediaElement}, Path=Volume, Mode=TwoWay}"
                    VerticalOptions="Center" />

            <Button Grid.Column="1"
                    Text="CC"
                    Command="{Binding ToggleSubtitlesCommand}"
                    IsVisible="{Binding HasSubtitles}"
                    Margin="5,0"
                    WidthRequest="50"
                    BackgroundColor="{Binding AreSubtitlesEnabled, Converter={StaticResource BoolToSubtitleButtonColorConverter}}"
                    TextColor="White" />

            <Button Grid.Column="2"
                    Text="📷"
                    Command="{Binding CaptureScreenshotCommand}"
                    Margin="5,0"
                    WidthRequest="50"
                    ToolTipProperties.Text="Take Screenshot" />

            <Button Grid.Column="3"
                    Text="ℹ️"
                    Command="{Binding ToggleVideoInfoCommand}"
                    Margin="5,0"
                    WidthRequest="50"
                    ToolTipProperties.Text="Video Information" />

            <Button Grid.Column="4"
                    Text="{Binding IsFavorite, Converter={StaticResource BoolToFavoriteTextConverter}}"
                    Command="{Binding ToggleFavoriteCommand}"
                    Margin="5,0,0,0" />
        </Grid>

    </Grid>

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:BoolToObjectConverter x:Key="BoolToFavoriteTextConverter"
                                          TrueObject="Unfavorite"
                                          FalseObject="Favorite" />
                                          
            <toolkit:BoolToObjectConverter x:Key="BoolToSubtitleButtonColorConverter"
                                          TrueObject="#008080"
                                          FalseObject="#808080" />
                                          
            <toolkit:BoolToObjectConverter x:Key="BoolToInfoButtonColorConverter"
                                          TrueObject="#008080"
                                          FalseObject="#808080" />
        </ResourceDictionary>
    </ContentPage.Resources>

</ContentPage>