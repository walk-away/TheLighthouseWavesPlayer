<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:TheLighthouseWavesPlayerVideoApp.ViewModels"
             x:DataType="vm:VideoPlayerViewModel"
             x:Class="TheLighthouseWavesPlayerVideoApp.Views.VideoPlayerPage"
             Title="{Binding Title}"
             Shell.NavBarIsVisible="True">

    <VisualStateManager.VisualStateGroups>
        <VisualStateGroup Name="OrientationStates">
            <VisualState Name="Portrait">
                <VisualState.Setters>
                    <Setter TargetName="TitleLabel" Property="IsVisible" Value="True" />
                    <Setter TargetName="BottomControlsGrid" Property="IsVisible" Value="True" />
                    <Setter TargetName="mediaElement" Property="Grid.Row" Value="1" />
                    <Setter TargetName="mediaElement" Property="Grid.RowSpan" Value="1" />
                    <Setter Property="Shell.NavBarIsVisible" Value="True" />
                </VisualState.Setters>
            </VisualState>
            <VisualState Name="Landscape">
                <VisualState.Setters>
                    <Setter TargetName="TitleLabel" Property="IsVisible" Value="False" />
                    <Setter TargetName="BottomControlsGrid" Property="IsVisible" Value="False" />
                    <Setter TargetName="mediaElement" Property="Grid.Row" Value="0" />
                    <Setter TargetName="mediaElement" Property="Grid.RowSpan" Value="3" />
                    <Setter Property="Shell.NavBarIsVisible" Value="False" />
                </VisualState.Setters>
            </VisualState>
        </VisualStateGroup>
    </VisualStateManager.VisualStateGroups>

    <Grid RowDefinitions="Auto, *, Auto">

        <Label Grid.Row="0"
               x:Name="TitleLabel"
               Text="{Binding Title}"
               FontSize="Large"
               HorizontalOptions="Center"
               Margin="10" />

        <Grid Grid.Row="1">
            <!-- Media Element -->
            <toolkit:MediaElement Grid.Row="1"
                              x:Name="mediaElement"
                              Source="{Binding VideoSource}"
                              ShouldAutoPlay="False"
                              ShouldShowPlaybackControls="True"
                              Aspect="AspectFit"
                              StateChanged="MediaElement_StateChanged"
                              MediaOpened="MediaElement_MediaOpened"
                              MediaEnded="MediaElement_MediaEnded"
                              PositionChanged="MediaElement_PositionChanged"
                              Volume="1" />

            <!-- Subtitle overlay -->
            <Border IsVisible="{Binding HasSubtitles}"
                   HorizontalOptions="Center"
                   VerticalOptions="End"
                   Margin="0,0,0,20"
                   StrokeShape="RoundRectangle 10"
                   BackgroundColor="#80000000"
                   Padding="10,5"
                   MaximumWidthRequest="600">
                <Label Text="{Binding CurrentSubtitleText}" 
                       TextColor="White" 
                       FontSize="18"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center" />
            </Border>
        </Grid>

        <Grid Grid.Row="2"
              x:Name="BottomControlsGrid"
              ColumnDefinitions="*, Auto, Auto"
              Margin="10"
              Padding="10,0"
              VerticalOptions="Center">

            <Slider Grid.Column="0"
                    x:Name="VolumeSlider"
                    Minimum="0"
                    Maximum="1"
                    Value="{Binding Source={x:Reference mediaElement}, Path=Volume, Mode=TwoWay}"
                    VerticalOptions="Center" />

            <Button Grid.Column="1"
                    Text="CC"
                    Command="{Binding ToggleSubtitlesCommand}"
                    IsVisible="{Binding HasSubtitles}"
                    Margin="10,0"
                    WidthRequest="50"
                    BackgroundColor="{Binding AreSubtitlesEnabled, Converter={StaticResource BoolToSubtitleButtonColorConverter}}"
                    TextColor="White"
                    HorizontalOptions="End" />

            <Button Grid.Column="2"
                    Text="{Binding IsFavorite, Converter={StaticResource BoolToFavoriteTextConverter}}"
                    Command="{Binding ToggleFavoriteCommand}"
                    Margin="0,0,0,0"
                    HorizontalOptions="End" />
        </Grid>

    </Grid>

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:BoolToObjectConverter x:Key="BoolToFavoriteTextConverter"
                                          TrueObject="Unfavorite"
                                          FalseObject="Favorite" />
                                          
            <toolkit:BoolToObjectConverter x:Key="BoolToSubtitleButtonColorConverter"
                                          TrueObject="#008080"
                                          FalseObject="#808080" />
        </ResourceDictionary>
    </ContentPage.Resources>

</ContentPage>