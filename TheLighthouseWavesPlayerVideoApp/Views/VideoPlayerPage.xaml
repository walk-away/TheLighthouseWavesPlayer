<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:TheLighthouseWavesPlayerVideoApp.ViewModels"
             xmlns:behaviors="clr-namespace:TheLighthouseWavesPlayerVideoApp.Behaviors"
             xmlns:localization1="clr-namespace:TheLighthouseWavesPlayerVideoApp.Localization"
             x:DataType="vm:VideoPlayerViewModel"
             x:Class="TheLighthouseWavesPlayerVideoApp.Views.VideoPlayerPage"
             Title="{Binding Title}"
             Shell.NavBarIsVisible="True">

    <VisualStateManager.VisualStateGroups>
        <VisualStateGroupList>
            <VisualStateGroup x:Name="OrientationStates">
                <VisualState x:Name="Portrait">
                    <VisualState.StateTriggers>
                        <OrientationStateTrigger Orientation="Portrait" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Property="Shell.NavBarIsVisible" Value="True" />
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="Landscape">
                    <VisualState.StateTriggers>
                        <OrientationStateTrigger Orientation="Landscape" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Property="Shell.NavBarIsVisible" Value="False" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateGroupList>
    </VisualStateManager.VisualStateGroups>

    <Grid RowDefinitions="Auto, *, Auto, Auto">
        <!-- Media player grid -->
        <Grid Grid.Row="1">
            <Frame CornerRadius="15"
                   BorderColor="Transparent"
                   Padding="0"
                   BackgroundColor="Black"
                   HasShadow="False"
                   HorizontalOptions="FillAndExpand"
                   VerticalOptions="FillAndExpand"
                   IsClippedToBounds="True">

                <!-- Media Element -->
                <toolkit:MediaElement x:Name="mediaElement"
                                      Source="{Binding VideoSource}"
                                      ShouldAutoPlay="True"
                                      ShouldShowPlaybackControls="True"
                                      Aspect="AspectFit"
                                      StateChanged="MediaElement_StateChanged"
                                      MediaOpened="MediaElement_MediaOpened"
                                      MediaEnded="MediaElement_MediaEnded"
                                      PositionChanged="MediaElement_PositionChanged"
                                      Volume="1" />
            </Frame>

            <!-- Subtitle overlay -->
            <Border IsVisible="{Binding HasSubtitles}"
                    Style="{StaticResource SubtitleContainerBorder}"
                    VerticalOptions="End"
                    Margin="0,0,0,20">
                <Label Text="{Binding CurrentSubtitleText}"
                       Style="{StaticResource SubtitleLabel}" />
            </Border>

            <!-- Video Info Overlay -->
            <Border IsVisible="{Binding IsVideoInfoVisible}"
                    StrokeShape="RoundRectangle 10"
                    Padding="15"
                    HorizontalOptions="End"
                    VerticalOptions="Start"
                    Margin="10"
                    BackgroundColor="{AppThemeBinding Light={StaticResource OverlayBackgroundLight}, Dark={StaticResource OverlayBackgroundDark}}"
                    StrokeThickness="0">
                <VerticalStackLayout Spacing="5">
                    <Label
                        Text="{Binding Source={x:Static localization1:LocalizedResourcesProvider.Instance}, Path=[VideoInfo_Header]}"
                        Style="{StaticResource OverlayHeaderLabelStyle}" />

                    <BoxView HeightRequest="1"
                             Opacity="0.5"
                             Margin="0,2,0,5"
                             BackgroundColor="{AppThemeBinding Light={StaticResource OverlayTextLight}, Dark={StaticResource OverlayTextDark}}" />

                    <Label Text="{Binding VideoInfo.FileName}" Style="{StaticResource OverlayLabelStyle}" />
                    <Label Text="{Binding VideoInfo.FormattedFileSize}" Style="{StaticResource OverlayLabelStyle}" />
                    <Label Text="{Binding VideoInfo.Resolution}" Style="{StaticResource OverlayLabelStyle}" />
                    <Label Text="{Binding VideoInfo.Duration, StringFormat='Duration: {0:hh\\:mm\\:ss}'}"
                           Style="{StaticResource OverlayLabelStyle}" />
                    <Label Text="{Binding VideoInfo.LastModified, StringFormat='Modified: {0:d}'}"
                           Style="{StaticResource OverlayLabelStyle}" />
                </VerticalStackLayout>
            </Border>

            <!-- Loading overlay -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
        </Grid>

        <!-- Playlist Navigation Controls Container -->
        <Border Grid.Row="2"
                StrokeShape="RoundRectangle 15"
                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}"
                StrokeThickness="1"
                Margin="10,5"
                Padding="15,10"
                IsVisible="{Binding IsPlaylistControlsVisible}">
            <Border.Shadow>
                <Shadow Brush="{AppThemeBinding Light={StaticResource Shadow2}, Dark={StaticResource Shadow3}}"
                        Offset="0,2"
                        Radius="4"
                        Opacity="0.3" />
            </Border.Shadow>

            <VisualStateManager.VisualStateGroups>
                <VisualStateGroupList>
                    <VisualStateGroup x:Name="OrientationStates">
                        <VisualState x:Name="Portrait">
                            <VisualState.StateTriggers>
                                <OrientationStateTrigger Orientation="Portrait" />
                            </VisualState.StateTriggers>
                            <VisualState.Setters>
                                <Setter Property="Margin" Value="10,5" />
                                <Setter Property="Padding" Value="15,10" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState x:Name="Landscape">
                            <VisualState.StateTriggers>
                                <OrientationStateTrigger Orientation="Landscape" />
                            </VisualState.StateTriggers>
                            <VisualState.Setters>
                                <Setter Property="Margin" Value="5,2" />
                                <Setter Property="Padding" Value="8,5" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </VisualStateManager.VisualStateGroups>

            <Grid ColumnDefinitions="Auto, Auto, *, Auto, Auto"
                  VerticalOptions="Center">

                <!-- Previous Button -->
                <Frame Grid.Column="0"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="0,0,3,0">
                    <ImageButton Style="{StaticResource ThemedIconButton}"
                                 Source="skipback.svg"
                                 Command="{Binding PreviousVideoCommand}"
                                 IsEnabled="{Binding CanGoToPrevious}"
                                 Opacity="{Binding CanGoToPrevious, Converter={StaticResource BoolToHighlightOpacityConverter}}"
                                 HeightRequest="24"
                                 WidthRequest="24" />
                </Frame>

                <!-- Next Button -->
                <Frame Grid.Column="1"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="0,0,3,0">
                    <ImageButton Style="{StaticResource ThemedIconButton}"
                                 Source="skipforward.svg"
                                 Command="{Binding NextVideoCommand}"
                                 IsEnabled="{Binding CanGoToNext}"
                                 Opacity="{Binding CanGoToNext, Converter={StaticResource BoolToHighlightOpacityConverter}}"
                                 HeightRequest="24"
                                 WidthRequest="24" />
                </Frame>

                <!-- Spacer -->
                <BoxView Grid.Column="2" />

                <!-- Repeat Mode Toggle -->
                <Grid Grid.Column="3" Margin="3,0">
                    <!-- None Mode -->
                    <Frame Style="{StaticResource VideoControlFrame}"
                           IsVisible="{Binding RepeatMode, Converter={StaticResource EnumEqualityConverter}, ConverterParameter=None}">
                        <ImageButton Source="repeat.svg"
                                     Command="{Binding ToggleRepeatModeCommand}"
                                     HeightRequest="24"
                                     WidthRequest="24"
                                     BackgroundColor="Transparent"
                                     Padding="0"
                                     Aspect="AspectFit"
                                     Opacity="0.5">
                            <ImageButton.Behaviors>
                                <toolkit:IconTintColorBehavior
                                    TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}" />
                            </ImageButton.Behaviors>
                        </ImageButton>
                    </Frame>

                    <!-- All Mode -->
                    <Frame Style="{StaticResource VideoControlFrame}"
                           IsVisible="{Binding RepeatMode, Converter={StaticResource EnumEqualityConverter}, ConverterParameter=All}">
                        <ImageButton Source="repeat.svg"
                                     Command="{Binding ToggleRepeatModeCommand}"
                                     HeightRequest="24"
                                     WidthRequest="24"
                                     BackgroundColor="Transparent"
                                     Padding="0"
                                     Aspect="AspectFit"
                                     behaviors:TintBehavior.TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}"
                                     Opacity="1.0">
                            <ImageButton.Behaviors>
                                <toolkit:IconTintColorBehavior
                                    TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}" />
                            </ImageButton.Behaviors>
                        </ImageButton>
                    </Frame>

                    <!-- One Mode -->
                    <Frame Style="{StaticResource VideoControlFrame}"
                           IsVisible="{Binding RepeatMode, Converter={StaticResource EnumEqualityConverter}, ConverterParameter=One}">
                        <Grid>
                            <ImageButton Source="repeat.svg"
                                         Command="{Binding ToggleRepeatModeCommand}"
                                         HeightRequest="24"
                                         WidthRequest="24"
                                         BackgroundColor="Transparent"
                                         Padding="0"
                                         Aspect="AspectFit"
                                         behaviors:TintBehavior.TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}"
                                         Opacity="1.0">
                                <ImageButton.Behaviors>
                                    <toolkit:IconTintColorBehavior
                                        TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}" />
                                </ImageButton.Behaviors>
                            </ImageButton>
                            <Label Text="1"
                                   FontSize="8"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"
                                   FontAttributes="Bold"
                                   InputTransparent="True" />
                        </Grid>
                    </Frame>
                </Grid>

                <!-- Shuffle Toggle -->
                <Frame Grid.Column="4"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="0,0,0,0">
                    <ImageButton Source="shuffle.svg"
                                 Command="{Binding ToggleShuffleCommand}"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 BackgroundColor="Transparent"
                                 Padding="0"
                                 Aspect="AspectFit"
                                 behaviors:TintBehavior.TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}">
                        <ImageButton.Behaviors>
                            <toolkit:IconTintColorBehavior
                                TintColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryAccent}}" />
                        </ImageButton.Behaviors>
                        <ImageButton.Triggers>
                            <DataTrigger TargetType="ImageButton"
                                         Binding="{Binding IsShuffleEnabled}"
                                         Value="True">
                                <Setter Property="Opacity" Value="1.0" />
                            </DataTrigger>
                            <DataTrigger TargetType="ImageButton"
                                         Binding="{Binding IsShuffleEnabled}"
                                         Value="False">
                                <Setter Property="Opacity" Value="0.5" />
                            </DataTrigger>
                        </ImageButton.Triggers>
                    </ImageButton>
                </Frame>
            </Grid>
        </Border>

        <!-- Main Controls Container -->
        <Border Grid.Row="3"
                StrokeShape="RoundRectangle 15"
                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}"
                StrokeThickness="1"
                Margin="10,5,10,10"
                Padding="15">
            <Border.Shadow>
                <Shadow Brush="{AppThemeBinding Light={StaticResource Shadow2}, Dark={StaticResource Shadow3}}"
                        Offset="0,2"
                        Radius="4"
                        Opacity="0.3" />
            </Border.Shadow>

            <VisualStateManager.VisualStateGroups>
                <VisualStateGroupList>
                    <VisualStateGroup x:Name="OrientationStates">
                        <VisualState x:Name="Portrait">
                            <VisualState.StateTriggers>
                                <OrientationStateTrigger Orientation="Portrait" />
                            </VisualState.StateTriggers>
                            <VisualState.Setters>
                                <Setter Property="Margin" Value="10,5,10,10" />
                                <Setter Property="Padding" Value="15" />
                            </VisualState.Setters>
                        </VisualState>
                        <VisualState x:Name="Landscape">
                            <VisualState.StateTriggers>
                                <OrientationStateTrigger Orientation="Landscape" />
                            </VisualState.StateTriggers>
                            <VisualState.Setters>
                                <Setter Property="Margin" Value="5,2,5,5" />
                                <Setter Property="Padding" Value="8,5" />
                            </VisualState.Setters>
                        </VisualState>
                    </VisualStateGroup>
                </VisualStateGroupList>
            </VisualStateManager.VisualStateGroups>

            <!-- Standard Controls -->
            <Grid x:Name="BottomControlsGrid"
                  ColumnDefinitions="Auto, Auto, *, Auto, Auto, Auto, Auto"
                  VerticalOptions="Center">

                <!-- Back Button - only visible in landscape mode -->
                <Frame Grid.Column="0"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="0,0,3,0"
                       x:Name="BackButtonFrame"
                       IsVisible="{Binding IsLandscape}">
                    <ImageButton x:Name="BackButton"
                                 Style="{StaticResource ThemedIconButton}"
                                 Source="arrow.svg"
                                 Command="{Binding GoBackCommand}"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 ToolTipProperties.Text="Back" />
                </Frame>

                <!-- Volume Icon -->
                <Frame Grid.Column="1"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="0,0,3,0">
                    <ImageButton x:Name="VolumeIcon"
                                 Style="{StaticResource ThemedIconButton}"
                                 Source="{Binding Source={x:Reference VolumeSlider}, Path=Value, Converter={StaticResource VolumeToIconConverter}}"
                                 Command="{Binding ToggleMuteCommand}"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 ToolTipProperties.Text="{Binding Source={x:Static localization1:LocalizedResourcesProvider.Instance}, Path=[Player_ToggleMute]}" />
                </Frame>

                <!-- Volume Slider -->
                <Slider Grid.Column="2"
                        x:Name="VolumeSlider"
                        Minimum="0"
                        Maximum="1"
                        MaximumWidthRequest="150"
                        Value="{Binding Source={x:Reference mediaElement}, Path=Volume, Mode=TwoWay}"
                        VerticalOptions="Center" />

                <!-- Subtitles Toggle Button -->
                <Frame Grid.Column="3"
                       BorderColor="{Binding AreSubtitlesEnabled, Converter={StaticResource BoolToSubtitleButtonColorConverter}}"
                       BackgroundColor="Transparent"
                       Padding="2"
                       CornerRadius="6"
                       HasShadow="False"
                       IsVisible="{Binding HasSubtitles}"
                       Margin="3,0">
                    <ImageButton Style="{StaticResource ThemedIconButton}"
                                 Source="sliders.svg"
                                 Command="{Binding ToggleSubtitlesCommand}"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 ToolTipProperties.Text="{Binding Source={x:Static localization1:LocalizedResourcesProvider.Instance}, Path=[Player_ToggleSubtitles]}" />
                </Frame>

                <!-- Screenshot Button -->
                <Frame Grid.Column="4"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="3,0">
                    <ImageButton Style="{StaticResource ThemedIconButton}"
                                 Source="image.svg"
                                 Command="{Binding CaptureScreenshotCommand}"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 ToolTipProperties.Text="{Binding Source={x:Static localization1:LocalizedResourcesProvider.Instance}, Path=[Player_Screenshot]}" />
                </Frame>

                <!-- Video Info Button -->
                <Frame Grid.Column="5"
                       Style="{StaticResource VideoControlFrame}"
                       Margin="3,0">
                    <ImageButton Style="{StaticResource ThemedIconButton}"
                                 Source="video.svg"
                                 Command="{Binding ToggleVideoInfoCommand}"
                                 HeightRequest="24"
                                 WidthRequest="24"
                                 ToolTipProperties.Text="{Binding Source={x:Static localization1:LocalizedResourcesProvider.Instance}, Path=[Player_VideoInfo]}" />
                </Frame>

                <!-- Favorite Toggle Button -->
                <Grid Grid.Column="6" Margin="3,0,0,0">
                    <Frame Style="{StaticResource VideoControlFrame}"
                           IsVisible="{Binding IsFavorite, Converter={StaticResource InverseBoolConverter}}">
                        <ImageButton Style="{StaticResource ThemedIconButton}"
                                     Source="bookmark.svg"
                                     Command="{Binding ToggleFavoriteCommand}"
                                     HeightRequest="24"
                                     WidthRequest="24" />
                    </Frame>

                    <Frame Style="{StaticResource VideoControlFrame}"
                           IsVisible="{Binding IsFavorite}">
                        <ImageButton Style="{StaticResource ThemedIconButton}"
                                     Source="trash.svg"
                                     Command="{Binding ToggleFavoriteCommand}"
                                     HeightRequest="24"
                                     WidthRequest="24" />
                    </Frame>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</ContentPage>
