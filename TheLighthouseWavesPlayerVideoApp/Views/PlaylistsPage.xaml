<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:TheLighthouseWavesPlayerVideoApp.ViewModels"
             xmlns:models="clr-namespace:TheLighthouseWavesPlayerVideoApp.Models"
             xmlns:localization="clr-namespace:TheLighthouseWavesPlayerVideoApp.Localization"
             x:Class="TheLighthouseWavesPlayerVideoApp.Views.PlaylistsPage"
             x:DataType="viewModels:PlaylistsViewModel">

    <ContentPage.Title>
        <Binding Path="[Playlists_Title]" Source="{x:Static localization:LocalizedResourcesProvider.Instance}" />
    </ContentPage.Title>

    <Grid RowDefinitions="Auto, *, Auto">
        <!-- Header with title and add button -->
        <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Padding="15,10">
            <Label Grid.Column="0" 
                   Text="{Binding Title}" 
                   FontSize="Large"
                   FontAttributes="Bold"
                   VerticalOptions="Center" />
            
            <Button Grid.Column="1"
                    Command="{Binding ShowAddNewPlaylistCommand}"
                    Text="+"
                    FontSize="Large"
                    WidthRequest="40"
                    HeightRequest="40"
                    Padding="0"
                    VerticalOptions="Center"
                    HorizontalOptions="End"
                    CornerRadius="20" />
        </Grid>

        <!-- Playlists List -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Playlists}"
                        SelectionMode="None"
                        Margin="0,5,0,0">
            <CollectionView.EmptyView>
                <StackLayout VerticalOptions="Center" HorizontalOptions="Center">
                    <Label Text="{Binding Path=[Playlists_EmptyList], Source={x:Static localization:LocalizedResourcesProvider.Instance}}" 
                           HorizontalOptions="Center" />
                    <Label Text="{Binding Path=[Playlists_CreateFirst], Source={x:Static localization:LocalizedResourcesProvider.Instance}}" 
                           HorizontalOptions="Center" 
                           Margin="0,5,0,0" />
                </StackLayout>
            </CollectionView.EmptyView>
            
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Playlist">
                    <Frame Margin="10,5" Padding="15" BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PlaylistsViewModel}}, Path=ViewPlaylistDetailsCommand}"
                                                  CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>
                        
                        <Grid ColumnDefinitions="*, Auto">
                            <!-- Playlist Info -->
                            <StackLayout Grid.Column="0" Spacing="5">
                                <Label Text="{Binding Name}" FontSize="Medium" FontAttributes="Bold" />
                                
                                <Label Text="{Binding Description}" 
                                       IsVisible="{Binding Description, Converter={StaticResource StringNotEmptyConverter}}"
                                       FontSize="Small" 
                                       TextColor="{AppThemeBinding Light=DarkGray, Dark=LightGray}"
                                       Margin="0,0,0,5" />
                                
                                <StackLayout Orientation="Horizontal" Spacing="15">
                                    <Label Text="{Binding VideoCountDisplay}" FontSize="Small" />
                                    <Label Text="{Binding TotalDurationDisplay}" FontSize="Small" />
                                </StackLayout>
                            </StackLayout>
                            
                            <!-- Delete Button -->
                            <Button Grid.Column="1"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PlaylistsViewModel}}, Path=DeletePlaylistCommand}"
                                    CommandParameter="{Binding .}"
                                    Text="×"
                                    FontSize="Large"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Padding="0"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Error}, Dark=IndianRed}"
                                    VerticalOptions="Start"
                                    HorizontalOptions="End"
                                    CornerRadius="20" />
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Activity Indicator -->
        <ActivityIndicator Grid.Row="1" 
                           IsRunning="{Binding IsBusy}" 
                           IsVisible="{Binding IsBusy}"
                           HorizontalOptions="Center" 
                           VerticalOptions="Center" />

        <!-- Add New Playlist Panel -->
        <Grid Grid.Row="0" Grid.RowSpan="3" 
              BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}"
              Opacity="0.9"
              IsVisible="{Binding IsAddingNewPlaylist}">
            
            <Frame VerticalOptions="Center" 
                   HorizontalOptions="Center" 
                   WidthRequest="300"
                   Padding="20">
                
                <StackLayout Spacing="15">
                    <Label Text="{Binding Path=[Playlists_Create], Source={x:Static localization:LocalizedResourcesProvider.Instance}}"
                           FontSize="Large" 
                           HorizontalOptions="Center" 
                           FontAttributes="Bold" />

                    <Entry Placeholder="{Binding Path=[Playlists_Name], Source={x:Static localization:LocalizedResourcesProvider.Instance}}"
                           Text="{Binding NewPlaylistName}" />

                    <Editor Placeholder="{Binding Path=[Playlists_Description], Source={x:Static localization:LocalizedResourcesProvider.Instance}}"
                            Text="{Binding NewPlaylistDescription}"
                            HeightRequest="100" />

                    <StackLayout Orientation="Horizontal" Spacing="10" HorizontalOptions="Center">
                        <Button Text="{Binding Path=[Playlists_Cancel], Source={x:Static localization:LocalizedResourcesProvider.Instance}}"
                                Command="{Binding CancelAddNewPlaylistCommand}"
                                WidthRequest="120" />
    
                        <Button Text="{Binding Path=[Playlists_CreateButton], Source={x:Static localization:LocalizedResourcesProvider.Instance}}"
                                Command="{Binding AddNewPlaylistCommand}"
                                WidthRequest="120" />
                    </StackLayout>
                </StackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>